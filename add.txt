# 创建新请求的页面 (需要登录)(发帖)
@app.route('/create_request', methods=['GET', 'POST'])
@login_required
def create_request():
    form = RequestForm()
    if form.validate_on_submit():
        title = form.title.data
        description = form.description.data
        new_request = Request(title=title, description=description, user_id=current_user.id)
        db.session.add(new_request)

        today = date.today()
        # 检查用户当天发帖是否已经获得积分5次
        points_today = Point.query.filter_by(user_id=current_user.id, date=today, type='post').count()
        if points_today < 5:
            # 添加积分
            point = Point(user_id=current_user.id, date=today, points=3, type='post')
            db.session.add(point)
            flash('+3 points for creating a post!', 'success')

        try:
            db.session.commit()
            flash('Request created successfully!', 'success')
            return redirect(url_for('post'))
        except Exception as e:
            db.session.rollback()
            flash(f'Error adding request: {e}', 'error')
    
    return render_template('create_request.html', form=form)
